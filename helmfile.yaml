repositories:
  - name: dapr
    url: https://dapr.github.io/helm-charts/
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: ratify
    url: https://deislabs.github.io/ratify
    
releases:
  - name: dapr
    namespace: dapr-system
    createNamespace: true
    chart: dapr/dapr
    version: 1.11.1
    wait: true
  - name: redis
    namespace: gatekeeper-system
    chart: bitnami/redis
    version: 17.11.6
    wait: true
    set:
      - name: image.tag
        value: 7.0-debian-11
      - name: replica.replicaCount
        value: 1
      - name: tls.enabled
        value: true
      - name: tls.autoGenerated
        value: true
      - name: tls.authClients
        value: false
  - name: ratify
    namespace: gatekeeper-system
    chart: charts/ratify/
    version: 1.8.0
    wait: true
    needs:
      - dapr-system/dapr
      - gatekeeper-system/redis
    hooks:
      - events: ["presync"]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "./test/testdata/dapr/dapr-redis-secret.yaml"
          - "-n"
          - "gatekeeper-system"
      - events: ["presync"]
        showlogs: true
        command: "kubectl"
        args:
          - "apply"
          - "-f"
          - "./test/testdata/dapr/dapr-redis.yaml"
          - "-n"
          - "gatekeeper-system"
      - events: ["postuninstall"]
        showlogs: true
        command: "kubectl"
        args:
          - "delete"
          - "-f"
          - "./test/testdata/dapr/dapr-redis-secret.yaml"
          - "-n"
          - "gatekeeper-system"
          - "--ignore-not-found=true"
      - events: ["postuninstall"]
        showlogs: true
        command: "kubectl"
        args:
          - "delete"
          - "-f"
          - "./test/testdata/dapr/dapr-redis.yaml"
          - "-n"
          - "gatekeeper-system"
          - "--ignore-not-found=true"
    set:
      - name: image.repository
        value: generaltest.azurecr.io/deislabs/ratify
      - name: image.crdRepository
        value: generaltest.azurecr.io/deislabs/ratify-crds
      - name: image.tag
        value: v1
      - name: featureFlags.RATIFY_CERT_ROTATION 
        value: false
      - name: featureFlags.RATIFY_DAPR_CACHE_PROVIDER
        value: true
      - name: logLevel
        value: debug
      - name: notaryCert
        file: ./test/testdata/notary.crt
      - name: replicaCount
        value: 2
      - name: provider.cache.type
        value: dapr
      - name: provider.cache.name
        value: dapr-redis
